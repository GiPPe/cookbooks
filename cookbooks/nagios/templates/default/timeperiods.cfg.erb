###############################################################################
# TIMEPERIODS.CFG - TIMEPERIOD DEFINITIONS
###############################################################################

define timeperiod {
  timeperiod_name 24x7
  name            24x7
  alias           24 Hours A Day, 7 Days A Week
  monday          00:00-24:00
  tuesday         00:00-24:00
  wednesday       00:00-24:00
  thursday        00:00-24:00
  friday          00:00-24:00
  saturday        00:00-24:00
  sunday          00:00-24:00
}

define timeperiod {
  timeperiod_name never
  name            never
  alias           No Time Is A Good Time
}

<%
# TODO: this looks like it needs refactoring
def convert_timeperiod(wday, periods)
  wday = {
    "mon" => "monday",
    "tue" => "tuesday",
    "wed" => "wednesday",
    "thu" => "thursday",
    "fri" => "friday",
    "sat" => "saturday",
    "sun" => "sunday"
  }[wday]

  timeperiods = node.run_state[:config].select do |c|
    c[:id] == "timeperiods"
  end.first

  periods.map do |p|
    p = timeperiods[p]
    "#{wday} #{p[:start]} - #{p[:end]}"
  end
end
%>

<% @contacts.each do |c| %>
define timeperiod {
  timeperiod_name <%= c[:id] %>-on-call
  alias <%= c[:id] %>-on-call
<% if c.include?(:on_call) %>
<% c[:on_call].sort.each do |wday, periods| %>
  <%= convert_timeperiod(wday, periods).join("\n  ") %>
<% end %>
<% else %>
  use 24x7
<% end %>
}

<% end %>
