<%page expression_filter="h"/>
<%inherit file="/layout/wizard.html"/>
<%namespace file="/lib.html" import="manager_save_search_link"/>
<%namespace name="lib" file="//lib.html" import="*"/>
<%namespace name="helpers" file="//view/_helpers.html" import="*"/>

<%def name="custom_css()">
  <%lib:stylesheet_tags files="${['/static/app/%s/application.css' % app, '/static/app/%s/help_tooltip.css' % app]}"/>
  <%lib:script_tags files="${['/static/app/%s/application.js' % app, '/static/app/%s/help_tooltip.js' % app]}" />
</%def>

<div class="content">
    % if exportJob:
        ${wizard_errors(header=_('Your scheduled hdfs export could not be saved.'), errors=exportJob.errors)}
    % endif
    <form action="${make_url(['custom', app , 'exportjobs', 'submitREDModal'])}" method="POST" name="addRED" id="addRED">
        ${csrf_hidden_input()}
        <input type="hidden" id="search" name="search" value="${search or ''}"/>
        <table>
            <tbody>
                <tr>
                    <td class="col1">
                        <label for="name" title="$export_name" class="help"><span class="required">*</span> ${_('Name')}</label>
                    </td>
                    <td class="col2">
                        <input type="text" id="name" name="name" value="${exportJob.name or ''}"/>
                    </td>
                </tr>
                <tr>
                    <td class="col1">
                        <label for="format" title="$export_format" class="help"><span class="required">*</span> ${_('Format')}</label>
                    </td>

                    <td class="col2">

                     <select id="format" name="format">
                        <option value="raw">${_('raw')}</option>
                        <option value="xml">${_('xml')}</option>
                        <option value="json">${_('json')}</option>
                        <option value="csv">${_('csv')}</option>
                        <option value="tsv">${_('tsv')}</option>
                     </select>
                    </td>
                </tr>
                <tr>
                    <td class="col1">
                        <label for="fields" title="$export_fields" class="help"><span class="required">*</span> ${_('Fields')}</label>
                    </td>
                    <td class="col2">
                        <input type="text" id="fields" name="fields" value="${exportJob.fields or ''}"/>
                        <p class="note">${_('(e.g. host, source, _raw)')}</p>
                    </td>
                </tr>
                <tr>
                    <td class="col1">
                        <label for="uri" title="$export_cluster" class="help"><span class="required">*</span> ${_('HDFS URI')}</label>
                    </td>
                    <td class="col2">
                        <select class="input-short principal-list" name="uri">
                            <option value="">${_('Select a cluster')}</option>
                            % for cluster in clusters:
                            <option value="${"hdfs://" + cluster.name}" ${'selected=true' if getattr(exportJob, 'uri') == "hdfs://" + getattr(cluster, 'name') else ''}>${cluster.name}</option>
                            % endfor
                        </select>
                        <p class="note">${_('(e.g. hdfs://hdfs.example.com:9000/)')}</p>
                    </td>
                </tr>
                <tr>
                    <td class="col1">
                        <label for="path" title="$export_base_path" class="help"><span class="required">*</span> ${_('HDFS base path')}</label>
                    </td>
                    <td class="col2">
                        <input type="text" id="path" name="base_path" value="${exportJob.base_path or ''}"/>
                        <p class="note">${_('(e.g. /home/export/data/)')}</p>
                    </td>
                </tr>
                <tr>
                    <td class="col1">
                        <label title="$export_partition" class="help">${_('Partition by:')}</label>
                    </td>
                    <td class="col2">

                    <input type="checkbox" class="checkbox" id="partition_date"   value="1" name="partition_date" ${'checked="checked"' if exportJob.hasPartitionField('date') else ''}/>
                    <label for="partition_date">${_('Date')}</label>

                    <input type="checkbox" class="checkbox" id="partition_hour"   value="1" name="partition_hour" ${'checked="checked"' if exportJob.hasPartitionField('hour') else ''}/>
                    <label for="partition_hour">${_('Hour')}</label>

                    <input type="checkbox" class="checkbox" id="partition_host"   value="1" name="partition_host" ${'checked="checked"' if exportJob.hasPartitionField('host') else ''}/>
                    <label for="partition_host">${_('Host')}</label>

                    <input type="checkbox" class="checkbox" id="partition_sourcetype" value="1" name="partition_sourcetype" ${'checked="checked"' if exportJob.hasPartitionField('sourcetype') else ''}/>
                    <label for="partition_sourcetype">${_('Sourcetype')}</label>

                    <input type="checkbox" class="checkbox" id="partition_source" value="1" name="partition_source" ${'checked="checked"' if exportJob.hasPartitionField('source') else ''}/>
                    <label for="partition_source">${_('Source')}</label>

                    </td>
                </tr>

                <tr>
                    <td class="col1">
                        <label title="$export_all_new" class="help">${_('Export from:')}</label>
                    </td>
                    <td class="col2">
                        <input type="text" class="datetime" name="datetime" id="datetime"/>
                        <input type="hidden" name="starttime" id="starttime" value="${exportJob.starttime or ''}"/>
                    </td>
                </tr>

                <tr>
                    <td class="col1">
                        <label title="$export_frequency" class="help">${_('Export frequency:')}</label>
                    </td>

                    <td class="col2">

                     <select name="cron_schedule">
                        <option value="*/15 * * * *">${_('Every 15 minutes')}</option>
                        <option value="*/30 * * * *">${_('Every 30 minutes')}</option>
                        <option value="0 * * * *" selected="selected">${_('Every hour')}</option>
                        <option value="0 */4 * * *">${_('Every 4 hours')}</option>
                        <option value="0 */4 * * *">${_('Every 12 hours')}</option>
                        <option value="0 0 * * *">${_('Every day')}</option>
                     </select>
                    </td>
                </tr>
                <tr>
                    <td class="col1">
                        <label title="$export_parallel_searches" class="help">${_('Parallel searches:')}</label>
                    </td>

                    <td class="col2">
                        <input type="text" id="parallel_searches" name="parallel_searches" class="input-mini" value="${exportJob.parallel_searches or ''}"/>
                    </td>

                </tr>




            </tbody>
        </table>
    </form>
</div>

<ul class="buttons splClearfix">
    <li class="left">
        <a href="${make_url(['custom', app, 'exportjobs', 'create'])}" class="splButton-secondary cancel">${_('Cancel')}</a>
    </li>
    <li class="right">
        <button class="splButton-primary" type="submit" onclick="$(document.forms[0]).trigger('submit');"><span>${_('Create') | n}</span></button>
    </li>
</ul>

<script type="text/javascript">
    $( function() {
        $('#datetime').bind('change', function(evt) {
            $('#starttime').val($('#datetime').datepicker('getDate').valueOf() / 1000 );
        });
        var dateFormat = $.datepicker._defaults['dateFormat'];
        var defaultDate = new  Date();

        $("#datetime").datepicker({
            currentText: '',
            defaultDate: defaultDate,
            prevText: '',
            nextText: ''
        });

        $('#datetime').val($.datepicker.formatDate(dateFormat, defaultDate)).trigger('change');

        $('#format').bind('change', function(evt) {
            var format = $('#format').val();
            if (format == "raw"){
                $('#fields').val('_raw');
                $('#fields').prop('disabled', true);
            }
            else {
                $('#fields').prop('disabled', false);
            }
        });
        $('#format').trigger('change');
    });
</script>
