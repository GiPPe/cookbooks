<%page expression_filter="h"/>
<%inherit file="/layout/base.html"/>
<%namespace file="/lib.html" import="manager_save_search_link"/>
<%namespace name="lib" file="//lib.html" import="*"/>
<%namespace name="helpers" file="//view/_helpers.html" import="*"/>

<%def name="custom_css()">
  <%lib:stylesheet_tags files="${['/static/css/view.css','/static/css/skins/default/default.css', '/static/app/%s/application.css' % app, '/static/app/%s/help_tooltip.css' % app]}"/>
  <%lib:script_tags files="${['/static/app/%s/application.js' % app, '/static/app/%s/help_tooltip.js' % app]}" />
</%def>
<%!
   def is_edit(cluster):
       return cluster.name and cluster.name.strip() != ''
%>
    <div class="clusters dashboardCell">
        <div class="splHeader splHeader-dashboard">
            % if is_edit(cluster):
            	<h2 title="Edit HDFS Cluster">Edit HDFS Cluster</h2>
	    % else:
            	<h2 title="Add New HDFS Cluster">Add new HDFS Cluster</h2>
            %endif
        </div>

        <div class="cluster">
            %  if cluster and getattr(cluster, 'errors', False):
                <div class="messages">
                    % for error in cluster.errors:
                        <p class="error"> ${error}</p>
                    % endfor
                </div>
            % endif
            <form class="clusterForm splClearfix" action="${make_url(['custom', app , 'config', 'clusters', 'add'])}" target="_top" method="POST" name="addCluster" id="addCluster">
                ${csrf_hidden_input()}

                <input type="text" style="display:none" name="id" value="${cluster.id or ''}"/>

                <div class="control-group">
                    <label title="$cluster_namenode" for="name" class="help">
                        ${_('HDFS URI')}
                        <span class="required">*</span>
                    </label>
                    % if is_edit(cluster):
                         <input type="hidden" id="name" name="name" value="${cluster.name}" />
                         <span> ${cluster.name} </span>
                    % else:
                        <input class="input-long" type="text" id="name" name="name" value="${cluster.name}" />
                        <p class="exampleText"><em>namenode.hadoop.example.com:8020</em></p>
                    % endif
                </div><!--/.control-group-->

                <div class="control-group">
                    <label for="hadoop_home" title="$cluster_hadoop_home" class="help">
                        ${_('HADOOP_HOME')}
                        <span class="required">*</span>
                    </label>
                    <input class="input-long" type="text" id="hadoop_home" name="hadoop_home" value="${cluster.hadoop_home or ''}"/>
                    <p class="exampleText"><em>/usr/hadoop/latest</em></p>
                </div><!--/.control-group-->

                <div class="control-group">
                    <label for="java_home" title="$cluster_java_home" class="help">
                        ${_('JAVA_HOME')}
                        <span class="required">*</span>
                    </label>
                    <input class="input-long" type="text" id="java_home" name="java_home" value="${cluster.java_home or ''}"/>
                    <p class="exampleText"><em>/usr/java/latest</em></p>
                </div><!--/.control-group-->


                <div class="control-group">
                    <label title="$cluster_http_port" for="namenode_http_port" class="help">
                        ${_('Namenode HTTP Port')}
                        <span class="required">*</span>
                    </label>
                    <input class="input-long" type="text" id="namenode_http_port" name="namenode_http_port" value="${50070 if not cluster.namenode_http_port else cluster.namenode_http_port}"/>
                    <p class="exampleText"><em>50070</em></p>
                </div><!--/.control-group-->

                <div class="control-group">
                    <input type="checkbox" class="checkbox secure" id="secure" name="secure" value="1" ${"checked=checked" if cluster.isSecure() else ''}/>
                    <label for="secure" title="$cluster_secure" class="help inline">
                        ${_('Set Security')}
                    </label>
                </div><!--/.control-group-->


                <div class="secureOptions" ${'' if cluster.isSecure() else ' style=display:none;'}>
                    <div class="control-group">
                        <label for="kerberos_service_principal" title="$cluster_service_principal" class="help">
                            ${_('HDFS Service Principal')}
                        </label>
                        <input class="input-long principal_list" id="kerberos_service_principal" name="kerberos_service_principal" value="${cluster.kerberos_service_principal  or ''}"/>
                        <p class="exampleText"><em>hdfs/namenode.hadoop.example.com@example.com</em></p>
                    </div><!--/.control-group-->

                    <div class="control-group">
                        <label for="kerberos_principal" title="kerberos_service_principal" class="help">
                            ${_('Select Export Kerberos Principal')}
                            <span class="required">*</span>
                        </label>
                        <select class="input-long principal_list" id="kerberos_principal" name="kerberos_principal">
                            <option value="">${_('Select a Kerberos Principal')}</option>
                            <option value="add" ${'selected=true' if getattr(cluster, 'kerberos_principal') == 'add' else ''}>${_('Add New Principal')}</option>
                            % for principal in principals:
                                <option value="${principal.name}" ${'selected=true' if getattr(principal, 'name') == getattr(cluster, 'kerberos_principal') else ''}>${principal.name}</option>
                            % endfor
                        </select>
                    </div><!--/.control-group-->

                    <div class="newPrincipal" ${'' if getattr(cluster, 'kerberos_principal') == 'add' else 'style=display:none;'}>
                        <div class="control-group">
                            <label for="principal_name" title="$kerberos_principal" class="help">
                                ${_('Name')}
                                <span class="required">*</span>
                            </label>
                            <input class="input-long" id="principal_name" name="principal_name" ${'value='+principal_name if principal_name else ''} ></input>
                            <p class="exampleText"><em>exporter@hadoop.example.com</em></p>
                        </div>

                        <div class="control-group">
                            <label for="principal_keytab_location" title="$kerberos_keytab_file" class="help">
                                ${_('Keytab Location on server')}
                                <span class="required">*</span>
                            </label>
                            <input class="input-long" id="principal_keytab_location" name="principal_keytab_location" ${'value='+principal_keytab_location if principal_keytab_location else ''} ></input>
                            <p class="exampleText"><em>/tmp/exporter.keytab</em></p>
                        </div><!--/.control-group-->
                    </div><!--/.newPrincipal-->
                </div><!--/.secureOptions-->

                <ul class="buttons splClearfix">
                    <li class="right">
                        <a href="${make_url(['app', app, 'config_clusters'])}" class="splButton-secondary cancel" target="_top">${_('Cancel')}</a>
                    </li>
                    <li class="left">
                        <input class="hdfsButton-primary" type="submit" id="submitClusters" value="Save"/>
                    </li>
                </ul>

            </form>
        </div>
    </div>

<script type="text/javascript">
    function makeClusterSecure(evt){
        var $target = $(evt.target);
        if ($target.is(':checked')) {
            $('.secureOptions').show();
        }
        else {
            $('.secureOptions').hide();
        }
    }

    function addPrincipal(evt){
        var $target = $(evt.target);
        if ($target.val() =="add") {
            $(".newPrincipal").show();
        }
        else {
            $(".newPrincipal").hide();
        }
    }


    $(function(){
        $(".principal_list").change(addPrincipal);
        $(".secure").bind('click', makeClusterSecure);

        if ( $('.principal_list').val() == 'add' )
        {
            $(".newPrincipal").show();
        }
    });
</script>
